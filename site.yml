# =============================================================================
# SellYourSaas - Playbook Principal de Instalaci√≥n
# =============================================================================
# Este playbook orquesta la instalaci√≥n completa de SellYourSaas
# incluyendo tanto el servidor master como el de deployment
# =============================================================================
---
- name: "=== INSTALACI√ìN SELLYOURSAAS - CONFIGURACI√ìN COMPLETA ==="
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "Mostrar informaci√≥n de la instalaci√≥n"
      debug:
        msg:
          - "=========================================="
          - "  INSTALACI√ìN SELLYOURSAAS AUTOMATIZADA"
          - "=========================================="
          - "Master Server: {{ master_server.hostname }} ({{ master_server.ip }})"
          - "Deploy Server: {{ deployment_server.hostname }} ({{ deployment_server.ip }})"
          - "Dominio Master: {{ master_server.domain }}"
          - "Dominio Deploy: {{ deployment_server.domain }}"
          - "Versi√≥n Dolibarr: {{ dolibarr.version }}"
          - "=========================================="

# =============================================================================
# FASE 1: CONFIGURACI√ìN B√ÅSICA Y PAQUETES COMUNES
# =============================================================================
- name: "FASE 1: Instalaci√≥n de paquetes comunes en ambos servidores"
  import_playbook: playbooks/shared/common_packages.yml

# =============================================================================
# FASE 2: CONFIGURACI√ìN MASTER SERVER
# =============================================================================
- name: "FASE 2.1: Configuraci√≥n SSH y usuarios en Master"
  import_playbook: playbooks/master/ssh_sudo.yml

- name: "FASE 2.2: Configuraci√≥n NFS Server en Master"
  import_playbook: playbooks/master/nfs_master.yml

- name: "FASE 2.3: Configuraci√≥n PHP en Master"
  import_playbook: playbooks/shared/php_config.yml
  vars:
    ansible_limit: master

- name: "FASE 2.4: Configuraci√≥n Apache en Master"
  import_playbook: playbooks/master/apache_master.yml

- name: "FASE 2.5: Configuraci√≥n MariaDB en Master"
  import_playbook: playbooks/master/mariadb_master.yml

- name: "FASE 2.6: Configuraci√≥n Fail2ban en Master"
  import_playbook: playbooks/master/fail2ban_master.yml

- name: "FASE 2.7: Configuraci√≥n SSL/Certbot en Master"
  import_playbook: playbooks/master/certbot_master.yml

- name: "FASE 2.8: Instalaci√≥n Dolibarr en Master"
  import_playbook: playbooks/master/dolibarr_master.yml

- name: "FASE 2.9: Configuraci√≥n Logrotate en Master"
  import_playbook: playbooks/shared/logrotate.yml
  vars:
    ansible_limit: master

- name: "FASE 2.10: Configuraci√≥n Cron en Master"
  import_playbook: playbooks/shared/cron.yml
  vars:
    ansible_limit: master

- name: "FASE 2.11: Configuraci√≥n AFICK en Master"
  import_playbook: playbooks/shared/afick.yml
  vars:
    ansible_limit: master

- name: "FASE 2.12: Configuraci√≥n Watchdog en Master"
  import_playbook: playbooks/master/watchdog_master.yml

# =============================================================================
# FASE 3: CONFIGURACI√ìN DEPLOYMENT SERVER
# =============================================================================
- name: "FASE 3.1: Configuraci√≥n SSH y usuarios en Deploy"
  import_playbook: playbooks/deploy/ssh_sudo.yml

- name: "FASE 3.2: Configuraci√≥n NFS Cliente en Deploy"
  import_playbook: playbooks/deploy/nfs_deploy.yml

- name: "FASE 3.3: Configuraci√≥n PHP en Deploy"
  import_playbook: playbooks/shared/php_config.yml
  vars:
    ansible_limit: deploy

- name: "FASE 3.4: Configuraci√≥n Apache en Deploy"
  import_playbook: playbooks/deploy/apache_deploy.yml

- name: "FASE 3.5: Configuraci√≥n Fail2ban en Deploy"
  import_playbook: playbooks/deploy/fail2ban_deploy.yml

- name: "FASE 3.6: Configuraci√≥n SSL/Certbot en Deploy"
  import_playbook: playbooks/shared/certbot.yml
  vars:
    ansible_limit: deploy

- name: "FASE 3.7: Configuraci√≥n Dolibarr Templates en Deploy"
  import_playbook: playbooks/deploy/dolibarr_deploy.yml

- name: "FASE 3.8: Configuraci√≥n Logrotate en Deploy"
  import_playbook: playbooks/shared/logrotate.yml
  vars:
    ansible_limit: deploy

- name: "FASE 3.9: Configuraci√≥n Cron espec√≠fico en Deploy"
  import_playbook: playbooks/deploy/cron_deploy.yml

- name: "FASE 3.10: Configuraci√≥n Cron general en Deploy"
  import_playbook: playbooks/shared/cron.yml
  vars:
    ansible_limit: deploy

- name: "FASE 3.11: Configuraci√≥n AFICK en Deploy"
  import_playbook: playbooks/shared/afick.yml
  vars:
    ansible_limit: deploy

- name: "FASE 3.12: Configuraci√≥n Watchdog en Deploy"
  import_playbook: playbooks/deploy/watchdog_deploy.yml

# =============================================================================
# FASE 4: VERIFICACI√ìN Y FINALIZACI√ìN
# =============================================================================
- name: "FASE 4: Verificaci√≥n final de la instalaci√≥n"
  hosts: all
  become: true
  gather_facts: yes
  tasks:
    - name: "Verificar servicios cr√≠ticos en Master"
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - apache2
        - mariadb
        - fail2ban
        - nfs-kernel-server
      when: inventory_hostname in groups['master']

    - name: "Verificar servicios cr√≠ticos en Deploy"
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - apache2
        - fail2ban
      when: inventory_hostname in groups['deploy']

    - name: "Verificar conectividad entre servidores"
      ping:
      delegate_to: "{{ item }}"
      loop: "{{ groups['all'] }}"
      when: inventory_hostname != item

    - name: "Verificar acceso a directorios cr√≠ticos"
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ directories.wwwroot }}"
        - "{{ directories.backups }}"
        - "{{ directories.scripts }}"
      check_mode: yes

    - name: "Mostrar resumen de instalaci√≥n por servidor"
      debug:
        msg:
          - "=========================================="
          - "INSTALACI√ìN COMPLETADA EN: {{ inventory_hostname }}"
          - "Tipo: {{ 'MASTER' if inventory_hostname in groups['master'] else 'DEPLOYMENT' }}"
          - "IP: {{ ansible_host }}"
          - "Hostname: {{ ansible_hostname }}"
          - "=========================================="

# =============================================================================
# FASE 5: INFORMACI√ìN FINAL
# =============================================================================
- name: "FASE 5: Informaci√≥n final y pr√≥ximos pasos"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "Mostrar informaci√≥n de acceso y pr√≥ximos pasos"
      debug:
        msg:
          - "================================================================"
          - "          INSTALACI√ìN SELLYOURSAAS COMPLETADA"
          - "================================================================"
          - ""
          - "üîß ACCESOS PRINCIPALES:"
          - "   ‚Ä¢ Admin Panel: https://admin.{{ master_server.domain }}"
          - "   ‚Ä¢ Customer Portal: https://myaccount.{{ master_server.domain }}"
          - "   ‚Ä¢ SSH Master: ssh {{ system_users.app_admin }}@{{ master_server.ip }} -p {{ ssh_config.port }}"
          - "   ‚Ä¢ SSH Deploy: ssh {{ system_users.app_admin }}@{{ deployment_server.ip }} -p {{ ssh_config.port }}"
          - ""
          - "üìä SERVICIOS CONFIGURADOS:"
          - "   ‚Ä¢ Base de datos: {{ database.main_db }} en {{ master_server.ip }}"
          - "   ‚Ä¢ Web Server: Apache con SSL autom√°tico"
          - "   ‚Ä¢ Monitoreo: Scripts autom√°ticos configurados"
          - "   ‚Ä¢ Backups: Programados diariamente"
          - "   ‚Ä¢ Seguridad: Fail2ban activo en ambos servidores"
          - ""
          - "üìÅ DIRECTORIOS IMPORTANTES:"
          - "   ‚Ä¢ Instancias: {{ directories.instances }}"
          - "   ‚Ä¢ Backups: {{ directories.backups }}"
          - "   ‚Ä¢ Scripts: {{ directories.scripts }}"
          - "   ‚Ä¢ Web Root: {{ directories.wwwroot }}"
          - ""
          - "üöÄ PR√ìXIMOS PASOS:"
          - "   1. Acceder al panel de administraci√≥n de Dolibarr"
          - "   2. Completar la configuraci√≥n inicial del m√≥dulo SellYourSaas"
          - "   3. Crear la primera instancia de prueba"
          - "   4. Configurar m√©todos de pago y plantillas"
          - "   5. Verificar el funcionamiento de backups y monitoreo"
          - ""
          - "üìß NOTIFICACIONES: {{ notifications.email }}"
          - "================================================================"

    - name: "Crear archivo de resumen de instalaci√≥n"
      copy:
        content: |
          # Resumen de Instalaci√≥n SellYourSaas
          Fecha de instalaci√≥n: {{ ansible_date_time.iso8601 }}
          
          ## Servidores Configurados
          - Master: {{ master_server.hostname }} ({{ master_server.ip }})
          - Deploy: {{ deployment_server.hostname }} ({{ deployment_server.ip }})
          
          ## Accesos
          - Admin Panel: https://admin.{{ master_server.domain }}
          - Customer Portal: https://myaccount.{{ master_server.domain }}
          - SSH Master: ssh {{ system_users.app_admin }}@{{ master_server.ip }} -p {{ ssh_config.port }}
          - SSH Deploy: ssh {{ system_users.app_admin }}@{{ deployment_server.ip }} -p {{ ssh_config.port }}
          
          ## Credenciales de Base de Datos
          - Host: {{ master_server.ip }}
          - Base de datos: {{ database.main_db }}
          - Usuario: {{ database.user }}
          - Puerto: 3306
          
          ## Scripts de Gesti√≥n
          - Crear instancia: {{ directories.scripts }}/create_instance.sh
          - Eliminar instancia: {{ directories.scripts }}/delete_instance.sh
          - Gestionar VHost: {{ directories.scripts }}/manage_vhost.sh
          - Backup manual: {{ directories.scripts }}/backup.sh
          
          ## Logs Importantes
          - Monitoreo Master: /var/log/service_monitor.log
          - Monitoreo Deploy: /var/log/service_monitor_deploy.log
          - Creaci√≥n Instancias: /var/log/instance_creation.log
          - Backups: /var/log/backup.log
          
          Para soporte, revisar la documentaci√≥n en documentation/
        dest: "./INSTALACION_COMPLETADA.md"
      delegate_to: localhost

    - name: "Archivo de resumen creado"
      debug:
        msg: "üìÑ Archivo de resumen guardado en: ./INSTALACION_COMPLETADA.md"
