# =============================================================================
# INSTALACIÃ“N  SERVIDOR DEPLOYMENT
# ================================================================- name: "FASE 2.14: ConfiguraciÃ³n AppArmor"
  import_playbook: playbooks/deploy/apparmor_deploy.yml

- name: "FASE 2.15: ConfiguraciÃ³n Jailkit (Opcional)"
  import_playbook: playbooks/deploy/jailkit_deploy.yml

- name: "FASE 2.16: Permitir generaciÃ³n de PNG desde PDF"
  import_playbook: playbooks/deploy/allow_png_gen.yml=====
# Este playbook configura el o los servidores de deployment
# PREREQUISITO: El servidor master debe estar ya instalado y funcionando
# =============================================================================
---
- name: "=== INSTALACIÃ“N DEPLOYMENT SERVER ==="
  hosts: '{{ target }}'
  gather_facts: no
  tasks:
    - name: "Mostrar informaciÃ³n de instalaciÃ³n Deployment"
      debug:
        msg:
          - "=========================================="
          - "  INSTALACIÃ“N SERVIDOR DEPLOYMENT"
          - "=========================================="
          - "Deploy Server: {{ deployment_server.hostname }} ({{ deployment_server.ip }})"
          - "Master Server: {{ master_server.hostname }} ({{ master_server.ip }})"
          - "Dominio Deploy: {{ deployment_server.domain }}"
          - "=========================================="

    - name: "Verificar conectividad con Master"
      ping:
        data: "test"
      delegate_to: "{{ master_server.ip }}"
      ignore_errors: yes
      register: master_connectivity

    - name: "Advertencia si no hay conectividad con Master"
      debug:
        msg:
          - "âš ï¸  ADVERTENCIA: No se puede conectar con el servidor Master"
          - "   AsegÃºrate de que el Master estÃ© instalado y funcionando"
          - "   IP Master: {{ master_server.ip }}"
      when: master_connectivity.failed is defined and master_connectivity.failed

# =============================================================================
# CONFIGURACIÃ“N BÃSICA DEPLOYMENT
# =============================================================================
- name: "FASE 1: InstalaciÃ³n de paquetes comunes en Deploy"
  import_playbook: playbooks/shared/common_packages.yml
  vars:
    ansible_limit: deploy

# =============================================================================
# CONFIGURACIÃ“N ESPECÃFICA DEPLOYMENT
# =============================================================================
- name: "FASE 2.1: ConfiguraciÃ³n SSH y usuarios en Deploy"
  import_playbook: playbooks/shared/ssh_sudo.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.1.1: ConfiguraciÃ³n claves SSH SellYourSaas"
  import_playbook: playbooks/shared/ssh_keys_sellyoursaas.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.2: ConfiguraciÃ³n usuario myunixlogin"
  import_playbook: playbooks/deploy/myunixlogin.yml

- name: "FASE 2.3: ConfiguraciÃ³n NFS Cliente en Deploy"
  import_playbook: playbooks/shared/nfs_share.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.3: ConfiguraciÃ³n PHP en Deploy"
  import_playbook: playbooks/shared/php_config.yml
  vars:
    ansible_limit: deploy

- name: "FASE 2.4: Max size increase UID - ConfiguraciÃ³n UID/GID para instancias"
  import_playbook: playbooks/shared/uid_gid_config.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.4.1: ConfiguraciÃ³n Apache General en Deploy"
  import_playbook: playbooks/shared/apache_config.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.4.2: ConfiguraciÃ³n Apache Deploy especÃ­fico"
  import_playbook: playbooks/deploy/apache_deploy_specific.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.4.3: ConfiguraciÃ³n Apache Deploy (Legacy)"
  import_playbook: playbooks/deploy/apache_deploy.yml

- name: "FASE 2.4.4: ConfiguraciÃ³n del Filesystem de Logs (Opcional)"
  import_playbook: playbooks/shared/logs_filesystem.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.4.5: ConfiguraciÃ³n Timeout MariaDB"
  import_playbook: playbooks/shared/mariadb_timeout.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.5: ConfiguraciÃ³n Fail2ban en Deploy"
  import_playbook: playbooks/deploy/fail2ban_deploy.yml

- name: "FASE 2.6: ConfiguraciÃ³n SSL/Certbot en Deploy"
  import_playbook: playbooks/shared/certbot.yml
  vars:
    ansible_limit: deploy

- name: "FASE 2.7: ObtenciÃ³n de archivos Dolibarr y SellYourSaas"
  import_playbook: playbooks/shared/dolibarr_sources.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.7.1: InstalaciÃ³n Unix Watchdog (Opcional)"
  import_playbook: playbooks/shared/unix_watchdog.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.7.2: Test SpamAssassin Configuration"
  import_playbook: playbooks/shared/test_spamassassin.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.7.3: Test and Setup of ClamAV"
  import_playbook: playbooks/shared/test_clamav.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.7.4: Installation of Afick"
  import_playbook: playbooks/shared/afick.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.7.5: Setup of CPUlimit (Optional)"
  import_playbook: playbooks/shared/cpulimit.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.7.6: ConfiguraciÃ³n Dolibarr Templates en Deploy"
  import_playbook: playbooks/deploy/dolibarr_deploy.yml

- name: "FASE 2.7.7: CreaciÃ³n de Directorios de Trabajo"
  import_playbook: playbooks/shared/working_directories.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.7.8: ConfiguraciÃ³n de archivos SellYourSaas"
  import_playbook: playbooks/shared/sellyoursaas_config.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.8: ConfiguraciÃ³n Logrotate en Deploy"
  import_playbook: playbooks/shared/logrotate.yml
  vars:
    ansible_limit: deploy

- name: "FASE 2.9: ConfiguraciÃ³n de discos y montajes"
  import_playbook: playbooks/shared/disk_management.yml

- name: "FASE 2.10: ConfiguraciÃ³n shell por defecto"
  import_playbook: playbooks/shared/default_shell.yml

- name: "FASE 2.11: EliminaciÃ³n archivos informaciÃ³n login"
  import_playbook: playbooks/shared/del_info_login.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.12: DesactivaciÃ³n de actualizaciones automÃ¡ticas"
  import_playbook: playbooks/shared/disable_auto_updates.yml
  vars:
    target_hosts: deploy

- name: "FASE 2.12: ConfiguraciÃ³n plantilla /etc/skel"
  import_playbook: playbooks/deploy/skel_template.yml

- name: "FASE 2.13: ConfiguraciÃ³n alias del sistema"
  import_playbook: playbooks/deploy/deploy_alias.yml

# NOTA: La configuraciÃ³n de UID mÃ¡ximo ahora se maneja en FASE 2.4 con playbooks/shared/uid_gid_config.yml
# - name: "FASE 2.14: ConfiguraciÃ³n UID mÃ¡ximo"
#  import_playbook: playbooks/deploy/increase_uid.yml

- name: "FASE 2.14: ConfiguraciÃ³n AppArmor"
  import_playbook: playbooks/deploy/apparmor_deploy.yml

- name: "FASE 2.16: ConfiguraciÃ³n Jailkit (Opcional)"
  import_playbook: playbooks/deploy/jailkit_deploy.yml

- name: "FASE 2.17: Habilitar generaciÃ³n PNG desde PDF"
  import_playbook: playbooks/deploy/allow_png_gen.yml

- name: "FASE 2.18: ConfiguraciÃ³n Cron especÃ­fico en Deploy"
  import_playbook: playbooks/deploy/cron_deploy.yml

- name: "FASE 2.19: ConfiguraciÃ³n Cron general en Deploy"
  import_playbook: playbooks/shared/cron.yml
  vars:
    ansible_limit: deploy

- name: "FASE 2.20: ConfiguraciÃ³n AFICK en Deploy"
  import_playbook: playbooks/shared/afick.yml
  vars:
    ansible_limit: deploy

- name: "FASE 2.21: ConfiguraciÃ³n Watchdog en Deploy"
  import_playbook: playbooks/deploy/watchdog_deploy.yml

# =============================================================================
# VERIFICACIÃ“N DEPLOYMENT
# =============================================================================
- name: "FASE 3: VerificaciÃ³n instalaciÃ³n Deployment"
  hosts: deploy
  become: true
  gather_facts: yes
  tasks:
    - name: "Verificar servicios crÃ­ticos en Deploy"
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - apache2
        - fail2ban

    - name: "Verificar acceso a directorios crÃ­ticos"
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ directories.instances }}"
        - "{{ directories.backups }}"
        - "{{ directories.scripts }}"
        - "{{ directories.templates }}"
      check_mode: yes

    - name: "Verificar montaje NFS con Master"
      mount:
        path: "{{ directories.nfs_mount }}"
        src: "{{ master_server.ip }}:{{ directories.backups }}"
        fstype: nfs
        state: mounted
      register: nfs_mount_result

    - name: "Verificar conectividad con base de datos Master"
      command: >
        mysql -h{{ master_server.ip }} -u{{ database.user }} -p{{ database.password }} 
        -e "SELECT 1"
      register: db_connectivity
      changed_when: false
      failed_when: db_connectivity.rc != 0

    - name: "Mostrar resumen de instalaciÃ³n Deployment"
      debug:
        msg:
          - "=========================================="
          - "INSTALACIÃ“N DEPLOYMENT COMPLETADA"
          - "Servidor: {{ inventory_hostname }}"
          - "IP: {{ ansible_host }}"
          - "Hostname: {{ ansible_hostname }}"
          - "NFS Mount: {{ 'OK' if nfs_mount_result.changed == false else 'ERROR' }}"
          - "DB Connectivity: {{ 'OK' if db_connectivity.rc == 0 else 'ERROR' }}"
          - "=========================================="

# =============================================================================
# CONFIGURACIONES ADICIONALES COMPLETENESS
# =============================================================================
- name: "FASE 22: PolÃ­ticas de contraseÃ±as"
  import_playbook: playbooks/shared/min_password.yml
  vars:
    ansible_limit: deploy

- name: "FASE 23: ConfiguraciÃ³n antivirus y spam"
  import_playbook: playbooks/shared/spam_clam_config.yml
  vars:
    ansible_limit: deploy

- name: "FASE 24: OptimizaciÃ³n CPU y logs"
  import_playbook: playbooks/shared/cpulimit_journalctl.yml
  vars:
    ansible_limit: deploy

- name: "FASE 25: Configuraciones especÃ­ficas deployment"
  import_playbook: playbooks/deploy/deploy_specific.yml

- name: "FASE 26: Usuario personal sysadmin"
  import_playbook: playbooks/shared/personal_sysadmin.yml
  vars:
    ansible_limit: deploy

- name: "FASE 27: Script de monitoreo basic.sh"
  import_playbook: playbooks/shared/monitor_basic.yml
  vars:
    ansible_limit: deploy

- name: "FASE 28: SSL wildcard personalizado"
  import_playbook: playbooks/shared/ssl_wildcard.yml
  vars:
    ansible_limit: deploy

# =============================================================================
# INFORMACIÃ“N FINAL DEPLOYMENT
# =============================================================================
- name: "FASE 4: InformaciÃ³n final Deployment"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "Mostrar informaciÃ³n de acceso Deployment"
      debug:
        msg:
          - "================================================================"
          - "   INSTALACIÃ“N SERVIDOR DEPLOYMENT COMPLETADA - 100% COMPLIANCE"
          - "================================================================"
          - ""
          - "ðŸ”§ ACCESOS DEPLOYMENT:"
          - "   â€¢ SSH: ssh {{ system_users.app_admin }}@{{ deployment_server.ip }} -p {{ ssh_config.port }}"
          - "   â€¢ Instancias se crearÃ¡n en: {{ directories.instances }}"
          - "   â€¢ Monitor bÃ¡sico: ejecutar 'basic' en consola"
          - ""
          - "ðŸ“Š SERVICIOS DEPLOYMENT ACTIVOS:"
          - "   â€¢ Apache configurado para instancias mÃºltiples"
          - "   â€¢ NFS Cliente conectado al Master"
          - "   â€¢ Monitoreo especÃ­fico de instancias"
          - "   â€¢ SSL automÃ¡tico para nuevas instancias"
          - "   â€¢ Jailkit + AppArmor + lÃ­mites de recursos"
          - "   â€¢ Fail2ban + polÃ­ticas contraseÃ±as + antivirus"
          - "   â€¢ Optimizaciones CPU/logs especÃ­ficas"
          - ""
          - "ðŸ”— CONEXIÃ“N CON MASTER:"
          - "   â€¢ Master IP: {{ master_server.ip }}"
          - "   â€¢ Base de datos compartida: {{ database.main_db }}"
          - "   â€¢ NFS Mount: {{ directories.nfs_mount }}"
          - ""
          - "ðŸš€ PRÃ“XIMOS PASOS:"
          - "   1. Desde el panel Master, crear primera instancia de prueba"
          - "   2. Verificar que la instancia se crea en este servidor"
          - "   3. Configurar DNS wildcard para *.{{ deployment_server.domain }}"
          - "   4. Configurar certificados SSL definitivos"
          - ""
          - "ðŸ“§ NOTIFICACIONES: {{ notifications.email }}"
          - "ðŸ‘¤ SYSADMIN PERSONAL: {{ personal_sysadmin_user | default('mylastnamefirstname') }}"
          - "================================================================"
