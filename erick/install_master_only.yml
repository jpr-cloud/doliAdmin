# =============================================================================
# INSTALACI√ìN SOLO SERVIDOR MASTER
# =============================================================================
# Este playbook instala √∫nicamente el servidor master de SellYourSaas
# =============================================================================
---
- name: "=== INSTALACI√ìN SOLO MASTER SERVER ==="
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "Mostrar informaci√≥n de instalaci√≥n Master"
      debug:
        msg:
          - "=========================================="
          - "  INSTALACI√ìN SOLO SERVIDOR MASTER"
          - "=========================================="
          - "Master Server: {{ master_server.hostname }} ({{ master_server.ip }})"
          - "Dominio Master: {{ master_server.domain }}"
          - "Versi√≥n Dolibarr: {{ dolibarr.version }}"
          - "=========================================="

# =============================================================================
# CONFIGURACI√ìN B√ÅSICA MASTER
# =============================================================================
- name: "FASE 1: Instalaci√≥n de paquetes comunes en Master"
  import_playbook: playbooks/shared/common_packages.yml
  vars:
    ansible_limit: master

# =============================================================================
# CONFIGURACI√ìN ESPEC√çFICA MASTER
# =============================================================================
- name: "FASE 2.1: Configuraci√≥n SSH y usuarios en Master"
  import_playbook: playbooks/master/ssh_sudo.yml

- name: "FASE 2.2: Configuraci√≥n NFS Server en Master"
  import_playbook: playbooks/master/nfs_master.yml

- name: "FASE 2.3: Configuraci√≥n PHP en Master"
  import_playbook: playbooks/shared/php_config.yml
  vars:
    ansible_limit: master

- name: "FASE 2.4: Configuraci√≥n Apache en Master"
  import_playbook: playbooks/master/apache_master.yml

- name: "FASE 2.5: Configuraci√≥n MariaDB en Master"
  import_playbook: playbooks/master/mariadb_master.yml

- name: "FASE 2.6: Configuraci√≥n Fail2ban en Master"
  import_playbook: playbooks/master/fail2ban_master.yml

- name: "FASE 2.7: Configuraci√≥n SSL/Certbot en Master"
  import_playbook: playbooks/master/certbot_master.yml

- name: "FASE 2.8: Instalaci√≥n Dolibarr en Master"
  import_playbook: playbooks/master/dolibarr_master.yml

- name: "FASE 2.9: Configuraci√≥n Logrotate en Master"
  import_playbook: playbooks/shared/logrotate.yml
  vars:
    ansible_limit: master

- name: "FASE 2.10: Configuraci√≥n Cron en Master"
  import_playbook: playbooks/shared/cron.yml
  vars:
    ansible_limit: master

- name: "FASE 2.11: Configuraci√≥n AFICK en Master"
  import_playbook: playbooks/shared/afick.yml
  vars:
    ansible_limit: master

- name: "FASE 2.12: Configuraci√≥n Watchdog en Master"
  import_playbook: playbooks/master/watchdog_master.yml

# =============================================================================
# VERIFICACI√ìN MASTER
# =============================================================================
- name: "FASE 3: Verificaci√≥n instalaci√≥n Master"
  hosts: master
  become: true
  gather_facts: yes
  tasks:
    - name: "Verificar servicios cr√≠ticos en Master"
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - apache2
        - mariadb
        - fail2ban
        - nfs-kernel-server

    - name: "Verificar acceso a directorios cr√≠ticos"
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ directories.wwwroot }}"
        - "{{ directories.backups }}"
        - "{{ directories.scripts }}"
      check_mode: yes

    - name: "Mostrar resumen de instalaci√≥n Master"
      debug:
        msg:
          - "=========================================="
          - "INSTALACI√ìN MASTER COMPLETADA"
          - "Servidor: {{ inventory_hostname }}"
          - "IP: {{ ansible_host }}"
          - "Hostname: {{ ansible_hostname }}"
          - "=========================================="

# =============================================================================
# INFORMACI√ìN FINAL MASTER
# =============================================================================
- name: "FASE 4: Informaci√≥n final Master"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "Mostrar informaci√≥n de acceso Master"
      debug:
        msg:
          - "================================================================"
          - "          INSTALACI√ìN SERVIDOR MASTER COMPLETADA"
          - "================================================================"
          - ""
          - "üîß ACCESOS MASTER:"
          - "   ‚Ä¢ Admin Panel: https://admin.{{ master_server.domain }}"
          - "   ‚Ä¢ Customer Portal: https://myaccount.{{ master_server.domain }}"
          - "   ‚Ä¢ SSH: ssh {{ system_users.app_admin }}@{{ master_server.ip }} -p {{ ssh_config.port }}"
          - ""
          - "üìä SERVICIOS MASTER ACTIVOS:"
          - "   ‚Ä¢ Base de datos: {{ database.main_db }} en {{ master_server.ip }}"
          - "   ‚Ä¢ Apache con SSL autom√°tico"
          - "   ‚Ä¢ NFS Server para backups compartidos"
          - "   ‚Ä¢ Monitoreo y backups autom√°ticos"
          - ""
          - "üöÄ PR√ìXIMOS PASOS:"
          - "   1. Acceder al panel de administraci√≥n"
          - "   2. Completar configuraci√≥n inicial de SellYourSaas"
          - "   3. Instalar servidor de deployment cuando est√© listo"
          - ""
          - "üìß NOTIFICACIONES: {{ notifications.email }}"
          - "================================================================"
