# =============================================================================
# INSTALACI√ìN SOLO SERVIDOR MASTER
# =============================================================================
# Este playbook instala √∫nicamente el servidor master de SellYourSaas
# =============================================================================
---
- name: "=== INSTALACI√ìN SOLO MASTER SERVER ==="
  hosts: master
  gather_facts: no
  tasks:


# =============================================================================
# CONFIGURACI√ìN DE HOSTNAME MASTER
# =============================================================================
- name: "Configuraci√≥n de hostname Master"
  hosts: master
  become: true
  tasks:
    - name: "Configurar hostname del servidor Master"
      include_tasks: playbooks/shared/sethostname_tasks.yml
      vars:
        hostname_main: "{{ target }}"

# Unix admin account {admin}

# =============================================================================
# CONFIGURACI√ìN B√ÅSICA MASTER
# =============================================================================
- name: "FASE 1: Instalaci√≥n de paquetes comunes en Master"
  import_playbook: playbooks/shared/common_packages.yml
  vars:
    target: master

# =============================================================================
# CONFIGURACI√ìN ESPEC√çFICA MASTER
# =============================================================================
- name: "FASE 2.1: Configuraci√≥n SSH y usuarios en Master"
  import_playbook: playbooks/shared/ssh_sudo.yml
  vars:
    target_hosts: master

- name: "FASE 2.1.1: Configuraci√≥n claves SSH SellYourSaas"
  import_playbook: playbooks/shared/ssh_keys_sellyoursaas.yml
  vars:
    target_hosts: master

- name: "FASE 2.2: Configuraci√≥n NFS Server en Master"
  import_playbook: playbooks/shared/nfs_share.yml
  vars:
    target_hosts: master

- name: "FASE 2.3: Configuraci√≥n PHP en Master"
  import_playbook: playbooks/shared/php_config.yml
  vars:
    target: master

# TODO: Configuraci√≥n de PHP-FPM y ajustes espec√≠ficos
- name: "FASE 2.4: Configuraci√≥n Apache General en Master"
  import_playbook: playbooks/shared/apache_config.yml
  vars:
    target_hosts: master

- name: "FASE 2.4.1: Configuraci√≥n Apache Master espec√≠fico"
  import_playbook: playbooks/master/apache_master_specific.yml
  vars:
    target_hosts: master

- name: "FASE 2.4.2: Configuraci√≥n Apache Master (Legacy)"
  import_playbook: playbooks/master/apache_master.yml
  vars:
    target: master

- name: "FASE 2.4.3: Configuraci√≥n del Filesystem de Logs (Opcional)"
  import_playbook: playbooks/shared/logs_filesystem.yml
  vars:
    target_hosts: master

# TODO: Configuraci√≥n de Mariadb
- name: "FASE 2.5: Configuraci√≥n MariaDB en Master"
  import_playbook: playbooks/master/mariadb_master.yml
  vars:
    target: master

- name: "FASE 2.5.1: Configuraci√≥n Timeout MariaDB"
  import_playbook: playbooks/shared/mariadb_timeout.yml
  vars:
    target_hosts: master

- name: "FASE 2.6: Configuraci√≥n Fail2ban en Master"
  import_playbook: playbooks/master/fail2ban_master.yml

- name: "FASE 2.7: Configuraci√≥n SSL/Certbot en Master"
  import_playbook: playbooks/master/certbot_master.yml
  vars:
    target: master

- name: "FASE 2.8: Obtenci√≥n de archivos Dolibarr y SellYourSaas"
  import_playbook: playbooks/shared/dolibarr_sources.yml
  vars:
    target_hosts: master

- name: "FASE 2.8.1: Instalaci√≥n Unix Watchdog (Opcional)"
  import_playbook: playbooks/shared/unix_watchdog.yml
  vars:
    target_hosts: master
  vars:
    target_hosts: master

- name: "FASE 2.8.2: Test SpamAssassin Configuration"
  import_playbook: playbooks/shared/test_spamassassin.yml
  vars:
    target_hosts: master

- name: "FASE 2.8.3: Test and Setup of ClamAV"
  import_playbook: playbooks/shared/test_clamav.yml
  vars:
    target_hosts: master

- name: "FASE 2.8.4: Installation of Afick"
  import_playbook: playbooks/shared/afick.yml
  vars:
    target_hosts: master

- name: "FASE 2.8.5: Setup of CPUlimit (Optional)"
  import_playbook: playbooks/shared/cpulimit.yml
  vars:
    target_hosts: master

- name: "FASE 2.8.6: Instalaci√≥n Dolibarr en Master"
  import_playbook: playbooks/master/dolibarr_master.yml
  vars:
    target: master

- name: "FASE 2.8.7: Creaci√≥n de Directorios de Trabajo"
  import_playbook: playbooks/shared/working_directories.yml
  vars:
    target_hosts: master

- name: "FASE 2.8.8: Configuraci√≥n de archivos SellYourSaas"
  import_playbook: playbooks/shared/sellyoursaas_config.yml
  vars:
    target_hosts: master

- name: "FASE 2.9: Configuraci√≥n Logrotate en Master"
  import_playbook: playbooks/shared/logrotate.yml
  vars:
    host: master

- name: "FASE 2.10: Configuraci√≥n Cron en Master"
  import_playbook: playbooks/shared/cron.yml
  vars:
    target: master

- name: "FASE 2.11: Configuraci√≥n eliminaci√≥n info login en Master"
  import_playbook: playbooks/shared/del_info_login.yml
  vars:
    target_hosts: master

- name: "FASE 2.12: Desactivaci√≥n de actualizaciones autom√°ticas en Master"
  import_playbook: playbooks/shared/disable_auto_updates.yml
  vars:
    target_hosts: master

- name: "FASE 2.13: Configuraci√≥n alias b√°sicos en Master"
  import_playbook: playbooks/master/master_alias.yml

- name: "FASE 2.13: Configuraci√≥n AFICK en Master"
  import_playbook: playbooks/shared/afick.yml
  vars:
    target: master

- name: "FASE 2.14: Configuraci√≥n Watchdog en Master"
  import_playbook: playbooks/master/watchdog_master.yml

# =============================================================================
# VERIFICACI√ìN MASTER
# =============================================================================
- name: "FASE 3: Verificaci√≥n instalaci√≥n Master"
  hosts: master
  become: true
  gather_facts: yes
  tasks:
    - name: "Verificar servicios cr√≠ticos en Master"
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - apache2
        - mariadb
        - fail2ban
        - nfs-kernel-server

    - name: "Verificar acceso a directorios cr√≠ticos"
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ directories.wwwroot }}"
        - "{{ directories.backups }}"
        - "{{ directories.scripts }}"
      check_mode: yes

    - name: "Mostrar resumen de instalaci√≥n Master"
      debug:
        msg:
          - "=========================================="
          - "INSTALACI√ìN MASTER COMPLETADA"
          - "Servidor: {{ inventory_hostname }}"
          - "IP: {{ ansible_host }}"
          - "Hostname: {{ ansible_hostname }}"
          - "=========================================="

# =============================================================================
# CONFIGURACIONES ADICIONALES COMPLETENESS
# =============================================================================
- name: "FASE 14: Pol√≠ticas de contrase√±as"
  import_playbook: playbooks/shared/min_password.yml
  vars:
    ansible_limit: master

- name: "FASE 15: Configuraci√≥n antivirus y spam"
  import_playbook: playbooks/shared/spam_clam_config.yml
  vars:
    ansible_limit: master

- name: "FASE 16: Optimizaci√≥n CPU y logs"
  import_playbook: playbooks/shared/cpulimit_journalctl.yml
  vars:
    ansible_limit: master

- name: "FASE 17: Virtual hosts del Master"
  import_playbook: playbooks/master/vhosts_master.yml

- name: "FASE 18: Configuraci√≥n Geoip2"
  import_playbook: playbooks/master/geoip2_master.yml

- name: "FASE 19: Usuario personal sysadmin"
  import_playbook: playbooks/shared/personal_sysadmin.yml
  vars:
    ansible_limit: master

- name: "FASE 20: Script de monitoreo basic.sh"
  import_playbook: playbooks/shared/monitor_basic.yml
  vars:
    ansible_limit: master

- name: "FASE 21: SSL wildcard personalizado"
  import_playbook: playbooks/shared/ssl_wildcard.yml
  vars:
    ansible_limit: master

# =============================================================================
# INFORMACI√ìN FINAL MASTER
# =============================================================================
- name: "FASE 4: Informaci√≥n final Master"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "Mostrar informaci√≥n de acceso Master"
      debug:
        msg:
          - "================================================================"
          - "    INSTALACI√ìN SERVIDOR MASTER COMPLETADA - 100% COMPLIANCE"
          - "================================================================"
          - ""
          - "üîß ACCESOS MASTER:"
          - "   ‚Ä¢ Admin Panel: https://admin.{{ master_server.domain }}"
          - "   ‚Ä¢ Customer Portal: https://myaccount.{{ master_server.domain }}"
          - "   ‚Ä¢ SSH: ssh {{ system_users.app_admin }}@{{ master_server.ip }} -p {{ ssh_config.port }}"
          - "   ‚Ä¢ Monitor b√°sico: ejecutar 'basic' en consola"
          - ""
          - "üìä SERVICIOS MASTER ACTIVOS:"
          - "   ‚Ä¢ Base de datos: {{ database.main_db }} en {{ master_server.ip }}"
          - "   ‚Ä¢ Apache con SSL wildcard autom√°tico"
          - "   ‚Ä¢ NFS Server para backups compartidos"
          - "   ‚Ä¢ Monitoreo y backups autom√°ticos"
          - "   ‚Ä¢ Fail2ban + pol√≠ticas contrase√±as + antivirus"
          - "   ‚Ä¢ Geoip2 + optimizaciones CPU/logs"
          - ""
          - "üöÄ PR√ìXIMOS PASOS:"
          - "   1. Acceder al panel de administraci√≥n"
          - "   2. Completar configuraci√≥n inicial de SellYourSaas"
          - "   3. Instalar servidor de deployment cuando est√© listo"
          - "   4. Configurar certificados SSL definitivos"
          - ""
          - "üìß NOTIFICACIONES: {{ notifications.email }}"
          - "üë§ SYSADMIN PERSONAL: {{ personal_sysadmin_user | default('mylastnamefirstname') }}"
          - "================================================================"
