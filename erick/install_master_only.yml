# =============================================================================
# INSTALACI√ìN SOLO SERVIDOR MASTER
# =============================================================================
# Este playbook instala √∫nicamente el servidor master de SellYourSaas
# =============================================================================
---
- name: "=== INSTALACI√ìN SOLO MASTER SERVER ==="
  hosts: master
  gather_facts: no
  tasks:


# =============================================================================
# CONFIGURACI√ìN DE HOSTNAME MASTER
# =============================================================================
- name: "Configuraci√≥n de hostname Master"
  hosts: master
  become: true
  tasks:
    - name: "Configurar hostname del servidor Master"
      include_tasks: playbooks/shared/sethostname_tasks.yml
      vars:
        hostname_main: "{{ target }}"

# =============================================================================
# CONFIGURACI√ìN B√ÅSICA MASTER
# =============================================================================
- name: "FASE 1: Instalaci√≥n de paquetes comunes en Master"
  import_playbook: playbooks/shared/common_packages.yml
  vars:
    target: master

# =============================================================================
# 'Unix personal sysadmin account': Creaci√≥n del usuario Unix Personal Sysadmin 
# =============================================================================
- name: "Creaci√≥n del usuario Unix Personal Sysadmin"
  import_playbook: playbooks/shared/UnixPersonalSysadminAccount.yml
  vars:
    target: master

# =============================================================================
# 'Unix admin account':Creaci√≥n del usuario admin y directorios de trabajo
# =============================================================================
- name: "Creaci√≥n del usuario admin y directorios de trabajo"
  import_playbook: playbooks/shared/UnixAdminAccount.yml
  vars:
    target: master

# =============================================================================
# 'SSH setup' Solo para deployment, no para master
# =============================================================================
- name: "SSH setup"
  import_playbook: playbooks/master/ssh.yml
  vars:
    target: master


# =============================================================================
# Creation of working directories
# =============================================================================
- name: Creaci√≥n de los directorios de trabajo
  import_playbook: playbooks/shared/working_directories.yml
  vars:
    target: master

# =============================================================================
# Getting files of Dolibarr and SellYourSaas application
# =============================================================================
- name: "[Getting files of Dolibarr and SellYourSaas application]: Instalaci√≥n Dolibarr en Master"
  import_playbook: playbooks/shared/getDolibarr.yml
  vars:
    target: master
# =============================================================================
# Creation of /.conf with credentials
# =============================================================================

- name: "FASE 2.1: Creaci√≥n de /conf con credenciales"
  import_playbook: playbooks/shared/confWithCredentials.yml
  vars:
    target: master
    scope: master

# =============================================================================
# Installing the nfs share
# =============================================================================

- name: "FASE 2.2: Configuraci√≥n NFS Server en Master"
  import_playbook: playbooks/master/nfs_master.yml
  vars:
    target: master
    nfs:
    internal_dest_ip: "{{ deployment_server.ip_internal | default(deployment_server.ip) }}"

# =============================================================================
# [FALTA] Deploy the public key of master admin on deployment admin account
# =============================================================================

# =============================================================================
# Installation of packages
#.  Apache web server configuration
# =============================================================================

- name: "FASE 2.3: Configuraci√≥n PHP en Master"
  import_playbook: playbooks/shared/php_config.yml
  vars:
    target: master

# TODO: Configuraci√≥n de PHP-FPM y ajustes espec√≠ficos
- name: "FASE 2.4: Configuraci√≥n Apache en Master"
  import_playbook: playbooks/master/apache_master.yml
  vars:
    target: master

- name: "FASE 2.12: Configuraci√≥n AFICK en Master"
  import_playbook: playbooks/shared/afick.yml
  vars:
    target: master

# TODO: Configuraci√≥n de Fail2ban
- name: "[Installation of fail2ban]: Configuraci√≥n Fail2ban en Master"
  import_playbook: playbooks/master/fail2ban_master.yml
  vars:
    target: master

# TODO: Configuraci√≥n de Mariadb
- name: "FASE 2.5: Configuraci√≥n MariaDB en Master"
  import_playbook: playbooks/master/mariadb_master.yml
  vars:
    target: master



- name: "FASE 2.7: Configuraci√≥n SSL/Certbot en Master"
  import_playbook: playbooks/master/certbot_master.yml
  vars:
    target: master



- name: "FASE 2.9: Configuraci√≥n Logrotate en Master"
  import_playbook: playbooks/shared/logrotate.yml
  vars:
    host: master

- name: "FASE 2.10: Configuraci√≥n Cron en Master"
  import_playbook: playbooks/shared/cron.yml
  vars:
    target: master

- name: "FASE 2.11: Configuraci√≥n alias b√°sicos en Master"
  import_playbook: playbooks/master/master_alias.yml



- name: "FASE 2.13: Configuraci√≥n Watchdog en Master"
  import_playbook: playbooks/master/watchdog_master.yml

# =============================================================================
# VERIFICACI√ìN MASTER
# =============================================================================
- name: "FASE 3: Verificaci√≥n instalaci√≥n Master"
  hosts: master
  become: true
  gather_facts: yes
  tasks:
    - name: "Verificar servicios cr√≠ticos en Master"
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - apache2
        - mariadb
        - fail2ban
        - nfs-kernel-server

    - name: "Verificar acceso a directorios cr√≠ticos"
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ directories.wwwroot }}"
        - "{{ directories.backups }}"
        - "{{ directories.scripts }}"
      check_mode: yes

    - name: "Mostrar resumen de instalaci√≥n Master"
      debug:
        msg:
          - "=========================================="
          - "INSTALACI√ìN MASTER COMPLETADA"
          - "Servidor: {{ inventory_hostname }}"
          - "IP: {{ ansible_host }}"
          - "Hostname: {{ ansible_hostname }}"
          - "=========================================="

# =============================================================================
# CONFIGURACIONES ADICIONALES COMPLETENESS
# =============================================================================
- name: "FASE 14: Pol√≠ticas de contrase√±as"
  import_playbook: playbooks/shared/min_password.yml
  vars:
    ansible_limit: master

- name: "FASE 15: Configuraci√≥n antivirus y spam"
  import_playbook: playbooks/shared/spam_clam_config.yml
  vars:
    ansible_limit: master

- name: "FASE 16: Optimizaci√≥n CPU y logs"
  import_playbook: playbooks/shared/cpulimit_journalctl.yml
  vars:
    ansible_limit: master

- name: "FASE 17: Virtual hosts del Master"
  import_playbook: playbooks/master/vhosts_master.yml

- name: "FASE 18: Configuraci√≥n Geoip2"
  import_playbook: playbooks/master/geoip2_master.yml

- name: "FASE 19: Usuario personal sysadmin"
  import_playbook: playbooks/shared/personal_sysadmin.yml
  vars:
    ansible_limit: master

- name: "FASE 20: Script de monitoreo basic.sh"
  import_playbook: playbooks/shared/monitor_basic.yml
  vars:
    ansible_limit: master

- name: "FASE 21: SSL wildcard personalizado"
  import_playbook: playbooks/shared/ssl_wildcard.yml
  vars:
    ansible_limit: master

# =============================================================================
# INFORMACI√ìN FINAL MASTER
# =============================================================================
- name: "FASE 4: Informaci√≥n final Master"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "Mostrar informaci√≥n de acceso Master"
      debug:
        msg:
          - "================================================================"
          - "    INSTALACI√ìN SERVIDOR MASTER COMPLETADA - 100% COMPLIANCE"
          - "================================================================"
          - ""
          - "üîß ACCESOS MASTER:"
          - "   ‚Ä¢ Admin Panel: https://admin.{{ master_server.domain }}"
          - "   ‚Ä¢ Customer Portal: https://myaccount.{{ master_server.domain }}"
          - "   ‚Ä¢ SSH: ssh {{ system_users.app_admin }}@{{ master_server.ip }} -p {{ ssh_config.port }}"
          - "   ‚Ä¢ Monitor b√°sico: ejecutar 'basic' en consola"
          - ""
          - "üìä SERVICIOS MASTER ACTIVOS:"
          - "   ‚Ä¢ Base de datos: {{ database.main_db }} en {{ master_server.ip }}"
          - "   ‚Ä¢ Apache con SSL wildcard autom√°tico"
          - "   ‚Ä¢ NFS Server para backups compartidos"
          - "   ‚Ä¢ Monitoreo y backups autom√°ticos"
          - "   ‚Ä¢ Fail2ban + pol√≠ticas contrase√±as + antivirus"
          - "   ‚Ä¢ Geoip2 + optimizaciones CPU/logs"
          - ""
          - "üöÄ PR√ìXIMOS PASOS:"
          - "   1. Acceder al panel de administraci√≥n"
          - "   2. Completar configuraci√≥n inicial de SellYourSaas"
          - "   3. Instalar servidor de deployment cuando est√© listo"
          - "   4. Configurar certificados SSL definitivos"
          - ""
          - "üìß NOTIFICACIONES: {{ notifications.email }}"
          - "üë§ SYSADMIN PERSONAL: {{ personal_sysadmin_user | default('mylastnamefirstname') }}"
          - "================================================================"
