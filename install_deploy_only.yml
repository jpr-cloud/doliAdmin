# =============================================================================
# INSTALACIÃ“N SOLO SERVIDOR DEPLOYMENT
# =============================================================================
# Este playbook instala Ãºnicamente el servidor de deployment
# PREREQUISITO: El servidor master debe estar ya instalado y funcionando
# =============================================================================
---
- name: "=== INSTALACIÃ“N SOLO DEPLOYMENT SERVER ==="
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "Mostrar informaciÃ³n de instalaciÃ³n Deployment"
      debug:
        msg:
          - "=========================================="
          - "  INSTALACIÃ“N SOLO SERVIDOR DEPLOYMENT"
          - "=========================================="
          - "Deploy Server: {{ deployment_server.hostname }} ({{ deployment_server.ip }})"
          - "Master Server: {{ master_server.hostname }} ({{ master_server.ip }})"
          - "Dominio Deploy: {{ deployment_server.domain }}"
          - "=========================================="

    - name: "Verificar conectividad con Master"
      ping:
        data: "test"
      delegate_to: "{{ master_server.ip }}"
      ignore_errors: yes
      register: master_connectivity

    - name: "Advertencia si no hay conectividad con Master"
      debug:
        msg:
          - "âš ï¸  ADVERTENCIA: No se puede conectar con el servidor Master"
          - "   AsegÃºrate de que el Master estÃ© instalado y funcionando"
          - "   IP Master: {{ master_server.ip }}"
      when: master_connectivity.failed is defined and master_connectivity.failed

# =============================================================================
# CONFIGURACIÃ“N BÃSICA DEPLOYMENT
# =============================================================================
- name: "FASE 1: InstalaciÃ³n de paquetes comunes en Deploy"
  import_playbook: playbooks/shared/common_packages.yml
  vars:
    ansible_limit: deploy

# =============================================================================
# CONFIGURACIÃ“N ESPECÃFICA DEPLOYMENT
# =============================================================================
- name: "FASE 2.1: ConfiguraciÃ³n SSH y usuarios en Deploy"
  import_playbook: playbooks/deploy/ssh_sudo.yml

- name: "FASE 2.2: ConfiguraciÃ³n NFS Cliente en Deploy"
  import_playbook: playbooks/deploy/nfs_deploy.yml

- name: "FASE 2.3: ConfiguraciÃ³n PHP en Deploy"
  import_playbook: playbooks/shared/php_config.yml
  vars:
    ansible_limit: deploy

- name: "FASE 2.4: ConfiguraciÃ³n Apache en Deploy"
  import_playbook: playbooks/deploy/apache_deploy.yml

- name: "FASE 2.5: ConfiguraciÃ³n Fail2ban en Deploy"
  import_playbook: playbooks/deploy/fail2ban_deploy.yml

- name: "FASE 2.6: ConfiguraciÃ³n SSL/Certbot en Deploy"
  import_playbook: playbooks/shared/certbot.yml
  vars:
    ansible_limit: deploy

- name: "FASE 2.7: ConfiguraciÃ³n Dolibarr Templates en Deploy"
  import_playbook: playbooks/deploy/dolibarr_deploy.yml

- name: "FASE 2.8: ConfiguraciÃ³n Logrotate en Deploy"
  import_playbook: playbooks/shared/logrotate.yml
  vars:
    ansible_limit: deploy

- name: "FASE 2.9: ConfiguraciÃ³n Cron especÃ­fico en Deploy"
  import_playbook: playbooks/deploy/cron_deploy.yml

- name: "FASE 2.10: ConfiguraciÃ³n Cron general en Deploy"
  import_playbook: playbooks/shared/cron.yml
  vars:
    ansible_limit: deploy

- name: "FASE 2.11: ConfiguraciÃ³n AFICK en Deploy"
  import_playbook: playbooks/shared/afick.yml
  vars:
    ansible_limit: deploy

- name: "FASE 2.12: ConfiguraciÃ³n Watchdog en Deploy"
  import_playbook: playbooks/deploy/watchdog_deploy.yml

# =============================================================================
# VERIFICACIÃ“N DEPLOYMENT
# =============================================================================
- name: "FASE 3: VerificaciÃ³n instalaciÃ³n Deployment"
  hosts: deploy
  become: true
  gather_facts: yes
  tasks:
    - name: "Verificar servicios crÃ­ticos en Deploy"
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - apache2
        - fail2ban

    - name: "Verificar acceso a directorios crÃ­ticos"
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ directories.instances }}"
        - "{{ directories.backups }}"
        - "{{ directories.scripts }}"
        - "{{ directories.templates }}"
      check_mode: yes

    - name: "Verificar montaje NFS con Master"
      mount:
        path: "{{ directories.nfs_mount }}"
        src: "{{ master_server.ip }}:{{ directories.backups }}"
        fstype: nfs
        state: mounted
      register: nfs_mount_result

    - name: "Verificar conectividad con base de datos Master"
      command: >
        mysql -h{{ master_server.ip }} -u{{ database.user }} -p{{ database.password }} 
        -e "SELECT 1"
      register: db_connectivity
      changed_when: false
      failed_when: db_connectivity.rc != 0

    - name: "Mostrar resumen de instalaciÃ³n Deployment"
      debug:
        msg:
          - "=========================================="
          - "INSTALACIÃ“N DEPLOYMENT COMPLETADA"
          - "Servidor: {{ inventory_hostname }}"
          - "IP: {{ ansible_host }}"
          - "Hostname: {{ ansible_hostname }}"
          - "NFS Mount: {{ 'OK' if nfs_mount_result.changed == false else 'ERROR' }}"
          - "DB Connectivity: {{ 'OK' if db_connectivity.rc == 0 else 'ERROR' }}"
          - "=========================================="

# =============================================================================
# INFORMACIÃ“N FINAL DEPLOYMENT
# =============================================================================
- name: "FASE 4: InformaciÃ³n final Deployment"
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "Mostrar informaciÃ³n de acceso Deployment"
      debug:
        msg:
          - "================================================================"
          - "        INSTALACIÃ“N SERVIDOR DEPLOYMENT COMPLETADA"
          - "================================================================"
          - ""
          - "ðŸ”§ ACCESOS DEPLOYMENT:"
          - "   â€¢ SSH: ssh {{ system_users.app_admin }}@{{ deployment_server.ip }} -p {{ ssh_config.port }}"
          - "   â€¢ Instancias se crearÃ¡n en: {{ directories.instances }}"
          - ""
          - "ðŸ“Š SERVICIOS DEPLOYMENT ACTIVOS:"
          - "   â€¢ Apache configurado para instancias mÃºltiples"
          - "   â€¢ NFS Cliente conectado al Master"
          - "   â€¢ Monitoreo especÃ­fico de instancias"
          - "   â€¢ SSL automÃ¡tico para nuevas instancias"
          - ""
          - "ðŸ”— CONEXIÃ“N CON MASTER:"
          - "   â€¢ Master IP: {{ master_server.ip }}"
          - "   â€¢ Base de datos compartida: {{ database.main_db }}"
          - "   â€¢ NFS Mount: {{ directories.nfs_mount }}"
          - ""
          - "ðŸš€ PRÃ“XIMOS PASOS:"
          - "   1. Desde el panel Master, crear primera instancia de prueba"
          - "   2. Verificar que la instancia se crea en este servidor"
          - "   3. Configurar DNS wildcard para *.{{ deployment_server.domain }}"
          - ""
          - "ðŸ“§ NOTIFICACIONES: {{ notifications.email }}"
          - "================================================================"
